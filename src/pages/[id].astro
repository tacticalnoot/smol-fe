---
import SmolResults from "../components/smol/SmolResults.svelte";
import Layout from "../layouts/Layout.astro";

const { id } = Astro.params;

const API_URL = import.meta.env.PUBLIC_API_URL || "https://api.smol.xyz";

// Fetch minimal data for SEO/meta tags only
let title: string | undefined;
let description: string | undefined;
let song_url: string | null = null;
let image_url: string | null = id ? `${API_URL}/image/${id}.png` : null;
let schema: any[] = [];
let lyricsDisplay = "";
let rawPrompt = "";
let createdDate = "";

if (id) {
    // PREVENT ROUTING CONFLICT: Explicitly reject known static routes that might fall through
    if (id === "radio") {
        return new Response(null, {
            status: 404,
            statusText: 'Not Found'
        });
    }

	try {
		const data = await fetch(`${API_URL}/${id}`, {
			headers: {
				Cookie: Astro.request.headers.get("cookie") ?? "",
			},
		}).then(async (res) => {
			if (res.ok) return res.json();
			return null;
		});

		if (data) {
			title = data.kv_do?.lyrics?.title || data.d1?.Title;
			const rawDesc = data.kv_do?.payload?.prompt || data.kv_do?.description || "AI generated song";
            // SEO: append value prop
            description = `${rawDesc} | Made with Smol AI Music Generator`;

			// Set song URL
			if (data.d1?.Song_1) {
				song_url = `${API_URL}/song/${data.d1.Song_1}.mp3`;
			} else if (data.kv_do?.songs?.[0]?.audio) {
				song_url = `${API_URL}/song/${data.kv_do.songs[0].music_id}.mp3`;
			}

            // Prepare SSR Content
            lyricsDisplay = data.kv_do?.lyrics?.text || data.kv_do?.lyrics || "";
            rawPrompt = data.kv_do?.payload?.prompt || "";
             
            // Schema
            const tags = data.kv_do?.tags || [];
            createdDate = data.d1?.Created || new Date().toISOString();

            schema = [{
                "@context": "https://schema.org",
                "@type": "MusicRecording",
                "@id": `${import.meta.env.PUBLIC_URL || 'https://noot.smol.xyz'}/${id}#recording`,
                "name": title,
                "url": `${import.meta.env.PUBLIC_URL || 'https://noot.smol.xyz'}/${id}`,
                "description": description,
                "datePublished": created,
                "image": image_url ? { "@type": "ImageObject", "url": image_url } : undefined,
                "audio": song_url ? {
                    "@type": "AudioObject",
                    "contentUrl": song_url,
                    "encodingFormat": "audio/mpeg"
                } : undefined,
                "genre": Array.isArray(tags) ? tags.slice(0, 5) : "AI Music",
                "inLanguage": "en",
                "isAccessibleForFree": true,
                "producer": {
                     "@type": "Organization",
                     "@id": `${import.meta.env.PUBLIC_URL || 'https://noot.smol.xyz'}/#organization`
                },
                "potentialAction": {
                    "@type": "ListenAction",
                    "target": `${import.meta.env.PUBLIC_URL || 'https://noot.smol.xyz'}/${id}`,
                    "expectsAcceptanceOf": {
                        "@type": "Offer",
                        "availability": "https://schema.org/OnlineOnly",
                        "price": "0.00",
                        "priceCurrency": "USD",
                        "eligibleRegion": {
                            "@type": "Place",
                            "name": "Worldwide"
                        }
                    }
                },
                "offers": {
                    "@type": "Offer",
                    "price": "0.01",
                    "priceCurrency": "XLM",
                    "description": "Mint as NFT on Stellar"
                }
             },
             {
                "@type": "VideoObject",
                "name": `${title} (AI Music Visualizer)`,
                "description": "Real-time AI generated music visualizer for this track.",
                "thumbnailUrl": image_url,
                "uploadDate": data.d1?.Created || new Date().toISOString(),
                "duration": "PT3M",
                "embedUrl": Astro.url.href,
                "playerType": "HTML5"
             },
             {
                "@context": "https://schema.org",
                "@type": "BreadcrumbList",
                "itemListElement": [
                  { "@type": "ListItem", "position": 1, "name": "Smol", "item": "https://noot.smol.xyz" },
                  { "@type": "ListItem", "position": 2, "name": "Songs", "item": "https://noot.smol.xyz" },
                  { "@type": "ListItem", "position": 3, "name": title, "item": `${import.meta.env.PUBLIC_URL || 'https://noot.smol.xyz'}/${id}` }
                ]
             }];
		}
	} catch (error) {
		console.error('Failed to fetch meta data:', error);
	}
}
---

<Layout {title} {description} {song_url} {image_url} hideBottomBar={true} {schema}>
	<div class="w-full min-h-[calc(100vh-80px)] lg:h-[calc(100vh-80px)] h-auto flex flex-col items-center justify-center lg:overflow-hidden overflow-y-auto pt-4 lg:pt-12 pb-8 px-4 lg:px-6">
		<div data-astro-transition-scope={`song-${id}`}>
			<SmolResults id={id as string} client:only="svelte" />
		</div>
        
        <!-- SSR Content for SEO (Visible but unobtrusive) -->
        <!-- SSR Content for SEO -->
        <div class="sr-only">
            <h1>{title}</h1>
            <h2>Description</h2>
            <p>{description}</p>
            {lyricsDisplay && (
                <section>
                    <h3>Lyrics</h3>
                    <p>{lyricsDisplay}</p>
                </section>
            )}
            <section>
                <h3>Details</h3>
                <p>Prompt: {rawPrompt}</p>
                <p>Created: {createdDate || "Unknown"}</p>
            </section>
        </div>
	</div>
</Layout>
