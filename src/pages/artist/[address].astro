---
import Layout from '../../layouts/Layout.astro';
import ArtistResults from '../../components/artist/ArtistResults.svelte';

// OOM FIX: Removed static snapshot import and getStaticPaths
// ArtistResults now fetches data client-side based on address

const { address } = Astro.params;
const { searchParams } = Astro.url;
const playId = searchParams.get('play');
const shuffle = searchParams.get("shuffle") === "true";
const seedParam = searchParams.get("seed");
const seed = seedParam ? Number.parseInt(seedParam, 10) : null;
const API_URL = import.meta.env.PUBLIC_API_URL || "https://api.smol.xyz";

let title = `Artist ${address?.substring(0, 6) || 'Unknown'}...`;
let description = "AI music artist on Smol. Browse discography, minted NFT songs, and collections.";
let image_url: string | undefined;
let song_url: string | undefined;
let schema: any[] = [];

// Add Person/MusicGroup schema for artist
if (address) {
    schema = [{
        "@context": "https://schema.org",
        "@type": "ProfilePage",
        "@id": `https://noot.smol.xyz/artist/${address}#profile`,
        "url": `https://noot.smol.xyz/artist/${address}`,
        "name": `Artist ${address.substring(0, 8)}...`,
        "description": "AI music creator profile on Smol.",
        "mainEntity": {
            "@type": "Person",
            "@id": `https://noot.smol.xyz/artist/${address}#person`,
            "name": `Artist ${address.substring(0, 8)}`,
            "description": "AI music composer and curator.",
            "url": `https://noot.smol.xyz/artist/${address}`,
            "interactionStatistic": [{
                "@type": "InteractionCounter",
                "interactionType": "https://schema.org/ListenAction",
                "userInteractionCount": 0
            }]
        }
    }];
}

if (playId) {
    try {
        const res = await fetch(`${API_URL}/${playId}`);
        if (res.ok) {
            const data = await res.json();
            title = data.kv_do?.lyrics?.title || data.d1?.Title || title;
            description = data.kv_do?.payload?.prompt || description;
            image_url = `${API_URL}/image/${playId}.png`;

            // Set song URL
			if (data.d1?.Song_1) {
				song_url = `${API_URL}/song/${data.d1.Song_1}.mp3`;
			} else if (data.kv_do?.songs?.[0]?.audio) {
				song_url = `${API_URL}/song/${data.kv_do.songs[0].music_id}.mp3`;
			}
        }
    } catch (e) {
        // Fail silently back to artist defaults
        console.error("Failed to hydrate meta for artist deep link", e);
    }
}
---

<Layout {title} {description} {image_url} {song_url} {schema}>
	<main class="h-[calc(100vh-52px)] overflow-hidden text-white p-0 md:px-4 max-w-7xl mx-auto -mt-[2px] md:mt-0" transition:animate="none">
        <ArtistResults
            client:only="svelte"
            address={address}
            shuffle={shuffle}
            seed={seed}
        />
	</main>
</Layout>
