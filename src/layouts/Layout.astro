---
import { ClientRouter } from 'astro:transitions';
import Header from '../components/Header.svelte'
import MixtapeBuilderOverlay from '../components/mixtape/MixtapeBuilderOverlay.svelte'
import BarAudioPlayer from '../components/audio/BarAudioPlayer.svelte'
import GlobalVerification from '../components/GlobalVerification.svelte'
import OnboardingGuard from '../components/onboarding/OnboardingGuard.svelte'
import PasskeyReprompt from '../components/retention/PasskeyReprompt.svelte'
import DynamicBackground from '../components/layout/DynamicBackground.svelte'
import '../styles/global.css'
import { buildCanonical, robotsMetaForUrl, jsonLd } from '../lib/seo';

interface Props {
	title?: string;
	description?: string;
	song_url?: string | null;
	image_url?: string | null;
	hideBottomBar?: boolean;
    schema?: any[]; // page-specific JSON-LD blocks
}

const {
	title,
	description = "Create and collect AI music onchain. The best AI music generator for making full songs from text prompts. Own your music.",
	song_url = "https://cdn2.aisonggenerator.io/491bb94b-79df-41bb-b09b-2d295f1dfd05.mp3",
	image_url,
	hideBottomBar = false,
    schema = []
} = Astro.props;

const siteOrigin = "https://noot.smol.xyz";
const canonical = buildCanonical(Astro.url, siteOrigin);
const robots = robotsMetaForUrl(Astro.url);

// Generate 2:1 social preview image URL for better Twitter/X display
let og_image_url = `${siteOrigin}/meta.png`;
let og_image_width = 1200;
let og_image_height = 630;

if (image_url) {
	// Extract ID from image URL (e.g., "https://api.smol.xyz/image/abc123.png" -> "abc123")
	const imageIdMatch = image_url.match(/\/image\/([^.?]+)/);
	if (imageIdMatch) {
		const imageId = imageIdMatch[1];
		// Use our 2:1 letterboxed endpoint for social previews
		og_image_url = `${siteOrigin}/api/og-image/${imageId}.png?scale=16`;
	} else {
		// Fallback to original image URL
		og_image_url = `${image_url}?scale=16`;
	}
}

let _kid = null
let _cid = null

const token = Astro.cookies.get('smol_token')?.value?.split('.')?.[1];

if (token) {
	const { sub, key } = JSON.parse(atob(token));

	_kid = key;
	_cid = sub;
}

// Global structured data
const siteSchema = [
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "@id": `${siteOrigin}#org`,
    "name": "Smol",
    "url": siteOrigin,
    "logo": `${siteOrigin}/favicon.png`,
    "sameAs": [
        "https://twitter.com/smolxyz",
        "https://github.com/smol-ai" 
    ]
  },
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "@id": `${siteOrigin}#website`,
    "url": siteOrigin,
    "name": "Smol â€” AI Music Generator",
    "potentialAction": {
      "@type": "SearchAction",
      "target": `${siteOrigin}/search?q={search_term_string}`,
      "query-input": "required name=search_term_string"
    }
  },
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "@id": `${siteOrigin}#app`,
    "name": "Smol",
    "url": siteOrigin,
    "applicationCategory": "MultimediaApplication",
    "operatingSystem": "Web",
    "description": "Generate songs from text prompts and collect them onchain."
  }
];

// Combine global schema with page-specific schema
const fullSchema = [...siteSchema, ...schema];
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
		<meta name="robots" content={robots} />
		
        <link rel="apple-touch-icon" href={image_url ? image_url : `${siteOrigin}/favicon.png`} />
		<link rel="icon" type="image/png" href={image_url ? image_url : `${siteOrigin}/favicon.png`} />
		
        <meta name="generator" content={Astro.generator} />
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="color-scheme" content="dark">
		<meta name="theme-color" content="#020617">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<meta name="apple-mobile-web-app-title" content={title}>
		<link rel="manifest" href="/manifest.json">
		<ClientRouter />

		<title transition:animate="fade">{title}</title>
		<meta name="description" content={description}>
        <meta name="keywords" content="AI music generator, AI songs, create music with AI, onchain music, crypto music, text to song, AI mixtape, Suno AI alternative, Udio alternative, make AI music" />
		<link rel="canonical" href={canonical}>

		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:type" content="music.song" />
		<meta property="og:url" content={canonical} />
		<meta property="og:site_name" content="Smol" />
		<meta property="og:image" content={og_image_url} />
		<meta property="og:image:width" content={og_image_width.toString()} />
		<meta property="og:image:height" content={og_image_height.toString()} />
		<meta property="og:audio" content={song_url} />
		<meta property="og:audio:secure_url" content={song_url} />
		<meta property="og:audio:type" content="audio/mpeg" />

		<meta name="twitter:card" content={song_url ? "player" : "summary_large_image"} />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={og_image_url} />
		<meta name="twitter:url" content={canonical} />
		
		{song_url && (
			<>
				<meta name="twitter:player" content={song_url} />
				<meta name="twitter:player:width" content="500" />
				<meta name="twitter:player:height" content="80" />
			</>
		)}

        {fullSchema.map(block => (
            <script type="application/ld+json" set:html={jsonLd(block)} />
        ))}

		<style is:global>
			/* Nuclear CSS option: globally hide SmolResults loading cards */
			[data-smol-loading] {
				display: none !important;
				visibility: hidden !important;
				opacity: 0 !important;
				pointer-events: none !important;
			}

			/* Hide scrollbars globally but keep functionality */
			::-webkit-scrollbar {
				display: none;
			}
			* {
				scrollbar-width: none;  /* Firefox */
				-ms-overflow-style: none;  /* IE and Edge */
			}
		</style>
	</head>
	<body class="bg-transparent text-white min-h-screen relative">
		<!-- Google Cast SDK -->
		<script is:inline src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

		<script is:inline>
			// Nuclear option: destroy SmolResults loading cards immediately and on all events
			function destroyLoadingCards() {
				const loadingCards = document.querySelectorAll('[data-smol-loading]');
				loadingCards.forEach(card => {
					card.style.display = 'none';
					card.remove();
				});
			}

			// Run immediately
			destroyLoadingCards();

			// Run on DOMContentLoaded
			document.addEventListener('DOMContentLoaded', destroyLoadingCards);

			// Run on Astro page load
			document.addEventListener('astro:page-load', destroyLoadingCards);

			// Run on Astro before swap
			document.addEventListener('astro:before-swap', destroyLoadingCards);

			// Run on Astro after swap
			document.addEventListener('astro:after-swap', destroyLoadingCards);

			// Observe for any new loading cards being added
			const observer = new MutationObserver(destroyLoadingCards);
			observer.observe(document.body || document.documentElement, {
				childList: true,
				subtree: true
			});
		</script>
		<!-- Global Dynamic Background (Pixel Kale Field) -->
		<DynamicBackground 
			client:only="svelte" 
			disableWeather={Astro.url.pathname.startsWith('/mixtapes') || Astro.url.pathname.startsWith('/kale')} 
			hidden={Astro.url.pathname.startsWith('/kale')}
		/>

		<Header _kid={_kid} _cid={_cid} client:load transition:persist="header" />
		<GlobalVerification client:only="svelte" />
		<OnboardingGuard client:only="svelte" isAuthenticatedServer={!!_cid} />
		<PasskeyReprompt client:load />
		
		<BarAudioPlayer client:only="svelte" transition:persist="audio-player" hideBottomBar={hideBottomBar || Astro.url.pathname.startsWith('/labs')} />

		<MixtapeBuilderOverlay client:load transition:persist="mixtape-builder" />
		<slot />
	</body>
</html>
